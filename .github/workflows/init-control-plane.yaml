name: Initialize Kubernetes Cluster

on:
  workflow_dispatch:

  workflow_run:
    workflows: ["Provision K8s Infrastructure"]
    types:
      - completed

jobs:
  init-k8s:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Connect via SSH and run kubeadm init, then save join command
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.CONTROL_PLANE_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ”§ Running kubeadm init script..."

            # Step 1: Run kubeadm-init.sh
            curl -O https://raw.githubusercontent.com/AmeeraRayan/PolybotInfra/main/scripts/kubeadm-init.sh
            chmod +x kubeadm-init.sh
            ./kubeadm-init.sh

            # Step 2: Save kubeadm join command to temp file
            echo "sudo $(kubeadm token create --print-join-command)" > /tmp/k8s_join.sh

            # Step 3: Install AWS CLI if not present
            if ! command -v aws &> /dev/null; then
              echo "Installing AWS CLI..."
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
            fi

            # Step 4: Save or update join command in AWS Secrets Manager
            aws secretsmanager create-secret \
              --name K8S_JOIN_COMMAND \
              --secret-string file:///tmp/k8s_join.sh \
              --region us-west-1 || \
            aws secretsmanager put-secret-value \
              --secret-id K8S_JOIN_COMMAND \
              --secret-string file:///tmp/k8s_join.sh \
              --region us-west-1
